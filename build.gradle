group 'hashcode.bali'
version '1.0-SNAPSHOT'

apply plugin: 'java'

sourceCompatibility = 1.8

repositories {
    mavenCentral()
}

dependencies {
    //testCompile group: 'junit', name: 'junit', version: '4.12'
}

// TODO appel envoi source

def inputs = new File("${buildDir}/resources/main/input/").listFiles().findAll{it.isFile()}
inputs.each {
    input ->
        def fichierSansExtension = input.name.split("\\.")[0]
        def output = "${buildDir}/libs/${fichierSansExtension}.out"
    task "bali-${fichierSansExtension}" (type: JavaExec, group: 'hashcode') {
        classpath sourceSets.main.runtimeClasspath
        standardInput = new FileInputStream(input.absoluteFile)
        def outputStream = new FileOutputStream(output)
        standardOutput = outputStream
        main = "hashcode.Main"
        doLast {
            print "Ecriture de la sortie ${output}\n"
            // eviter les locks sur les fichiers
            outputStream.withCloseable {it.close()}
            standardOutput = System.out
        }
    }
}

task 'bali-All' (group: 'hashcode') {
    inputs.each {
        dependsOn "bali-${it.name.split("\\.")[0]}"
    }
    dependsOn 'sourcesJar'
}

task sourcesJar(type: Jar, dependsOn: classes) {
    classifier = 'sources'
    from sourceSets.main.allJava
}