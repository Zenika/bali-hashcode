group 'hashcode.bali'
version '1.0-SNAPSHOT'

apply plugin: 'java'

sourceCompatibility = 1.8

repositories {
    mavenCentral()
}

dependencies {
    //testCompile group: 'junit', name: 'junit', version: '4.12'
}

// TODO appel envoi source

def inputs = new File("${buildDir}/resources/main/input/").listFiles().findAll{it.isFile() && it.name.endsWith(".txt")}
inputs.each {
    input ->
        def fichierSansExtension = input.name.split("\\.")[0]
        def output = "${buildDir}/libs/${fichierSansExtension}.out.txt"
    task "bali-${fichierSansExtension}" (type: JavaExec, group: 'hashcode') {
        classpath sourceSets.main.runtimeClasspath
        standardInput = new FileInputStream(input.absoluteFile)
        def outputStream = new FileOutputStream(output)
        standardOutput = outputStream
        main = "hashcode.Main"
        doLast {
            print "Ecriture de la sortie ${output}\n"
            // eviter les locks sur les fichiers
            outputStream.withCloseable {it.close()}
            standardOutput = System.out
        }
    }
}

task 'bali-generate-outputs' (group: 'hashcode') {
    inputs.each {
        dependsOn "bali-${it.name.split("\\.")[0]}"
    }
    dependsOn 'sourcesJar'
}

task sourcesJar(type: Jar, dependsOn: classes) {
    classifier = 'sources'
    from sourceSets.main.allJava
}

task 'bali-download' (type: Exec, group: 'hashcode') {
    def cmd = npmCommand('npm run download --prefix ../hash-code-2018-training/')
    commandLine cmd.split(' ')
}

task 'bali-submit' (type: Exec, group: 'hashcode') {
    dependsOn 'bali-generate-outputs'
    def cmd = npmCommand('npm run upload --prefix ../hash-code-2018-training/')
    commandLine cmd.split(' ')
}

def npmCommand(def cmd) {
    if (org.gradle.internal.os.OperatingSystem.current().isWindows()) {
        cmd =  'cmd /C '.concat(cmd)
    }
    cmd
}